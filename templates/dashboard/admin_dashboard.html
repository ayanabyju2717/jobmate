{% extends "base.html" %}
{% block title %}Admin Dashboard â€“ JobMate{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, var(--jm-primary) 0%, #7c3aed 100%); padding: 2.5rem 0;">
    <div class="container">
        <h3 class="text-white fw-bold mb-0"><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h3>
        <p class="text-white-50 mb-0 small">Monitor platform activity, verify employees, and track revenue</p>
    </div>
</div>

<div class="container py-5">
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <div class="stat-icon text-primary"><i class="bi bi-people-fill"></i></div>
                <h2>{{ total_users }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Total Users</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <div class="stat-icon text-success"><i class="bi bi-person-workspace"></i></div>
                <h2>{{ total_employees }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Employees</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <div class="stat-icon text-info"><i class="bi bi-journal-check"></i></div>
                <h2>{{ total_bookings }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Total Bookings</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <div class="stat-icon" style="color: var(--jm-accent);"><i class="bi bi-currency-dollar"></i></div>
                <h2 style="color: var(--jm-accent);">${{ revenue }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Revenue</p>
            </div>
        </div>
    </div>

    <!-- Second row of stats -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <h2>{{ total_customers }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Customers</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <h2 class="{% if pending_verifications > 0 %}text-warning{% endif %}">{{ pending_verifications }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Pending Verification</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <h2>{{ recent_bookings_count }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Bookings (30 days)</p>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card stat-card hover-lift">
                <h2>{{ bookings_by_status.completed|default:"0" }}</h2>
                <p class="text-muted mb-0 small fw-semibold">Completed Jobs</p>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Recent Bookings -->
        <div class="col-lg-8">
            <div class="card p-4">
                <h5 class="section-title"><i class="bi bi-clock-history me-2 text-primary"></i>Recent Bookings</h5>
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Customer</th>
                                <th>Employee</th>
                                <th>Status</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in latest_bookings %}
                            <tr>
                                <td class="fw-semibold text-muted">{{ b.pk }}</td>
                                <td class="fw-semibold">{{ b.title|truncatechars:25 }}</td>
                                <td>{{ b.customer.username }}</td>
                                <td>{{ b.employee.username }}</td>
                                <td>
                                    <span class="badge
                                        {% if b.status == 'completed' %}bg-success
                                        {% elif b.status == 'pending' %}bg-warning text-dark
                                        {% elif b.status == 'in_progress' %}bg-primary
                                        {% elif b.status == 'accepted' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {{ b.get_status_display }}
                                    </span>
                                </td>
                                <td class="fw-bold text-primary">${{ b.total_cost }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-muted text-center py-4">No bookings yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Unverified Employees -->
            <div class="card p-4 mb-4">
                <h5 class="section-title">
                    <i class="bi bi-shield-exclamation me-2 text-warning"></i>Pending Approvals
                    {% if pending_verifications > 0 %}
                    <span class="badge bg-warning text-dark ms-2">{{ pending_verifications }}</span>
                    {% endif %}
                </h5>
                <div class="mt-3">
                    {% for ep in unverified_employees %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-3">
                        <div>
                            <strong class="d-block">{{ ep.user.get_full_name|default:ep.user.username }}</strong>
                            <small class="text-muted">{{ ep.user.email }}</small>
                        </div>
                        <a href="{% url 'verify_employee' ep.pk %}" class="btn btn-sm btn-accent">
                            <i class="bi bi-check-lg me-1"></i>Verify
                        </a>
                    </div>
                    {% empty %}
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle text-success fs-3"></i>
                        <p class="text-muted mb-0 mt-2 small">All employees verified</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Fraud Flags -->
            <div class="card p-4">
                <h5 class="section-title">
                    <i class="bi bi-exclamation-triangle me-2 text-danger"></i>Fraud Flags
                </h5>
                <div class="mt-3">
                    {% for u in fraud_flags %}
                    <div class="border-bottom py-3">
                        <strong class="d-block">{{ u.get_full_name|default:u.username }}</strong>
                        <div class="mt-1">
                            <span class="badge bg-danger bg-opacity-10 text-danger me-1">{{ u.cancelled }} cancellations</span>
                            <span class="badge bg-warning bg-opacity-10 text-warning">{{ u.rejected }} rejections</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-3">
                        <i class="bi bi-shield-check text-success fs-3"></i>
                        <p class="text-muted mb-0 mt-2 small">No suspicious activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
